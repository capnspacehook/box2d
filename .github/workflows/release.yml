name: Archives

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ "*" ]

jobs:
  release-linux-amd64:
    name: linux-amd64
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update && \
        sudo apt-get install -y --no-install-recommends \
        ninja-build

        sudo wget https://apt.llvm.org/llvm.sh
        chmod +x llvm.sh
        sudo ./llvm.sh 20

    - name: Configure CMake
      run: |
        cmake -B ${{github.workspace}}/build -GNinja \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
        -DBOX2D_AVX2=ON \
        -DBOX2D_DISABLE_SIMD=OFF \
        -DBUILD_SHARED_LIBS=OFF \
        -DBOX2D_SAMPLES=OFF \
        -DBOX2D_VALIDATE=OFF \
        -DBOX2D_UNIT_TESTS=OFF \
        -DCMAKE_C_FLAGS="-DB2_MAX_WORLDS=65534"

    - name: Build
      run: cmake --build ${{github.workspace}}/build --config Release

    - name: Package
      working-directory: ${{github.workspace}}/build
      run: |
        mkdir release
        cp src/libbox2d.a release
        cp -r ../include ../src/*.h release
        tar -czvf box2d-linux-amd64.tar.gz release

    - name: Upload Artifact to Release
      uses: softprops/action-gh-release@v1
      with:
        files: ${{github.workspace}}/build/box2d-linux-amd64.tar.gz
